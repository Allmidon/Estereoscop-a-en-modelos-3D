<!DOCTYPE html>
<html lang="es">
<head>
    <title>WebXR - Dos Entornos con Menú VR</title>
    <meta charset="utf-g" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            overflow: hidden;
        }
        #app-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            color: white;
            text-shadow: 2px 2px 4px #000000;
        }
        .menu {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: auto;
        }
        #menu-ui, #game-ui {
            display: none;
        }
        button {
            font-size: 1.2em;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    
    <div id="app-container"></div>

    <div id="ui-overlay">
        <div id="menu-ui" class="menu">
            <h1>Menú Principal</h1>
            <button id="btn-to-env1">Ir al Mapa (Entorno 1)</button>
            <button id="btn-to-env2">Ir al Personaje (Entorno 2)</button>
        </div>
        <div id="game-ui" class="menu">
            <button id="btn-to-menu">Volver al Menú</button>
            <button id="btn-to-other">Ir al otro entorno</button>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">

        import * as THREE from 'three';
        import { VRButton } from 'three/addons/webxr/VRButton.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- Variables Globales ---
        let camera, scene, renderer, clock, mixer;
        let controls;
        let currentState = 'MENU';
        
        // --- NUEVAS Variables para VR ---
        let controller, reticle, raycaster, interactableGroup;

        // Elementos de la UI HTML
        const uiMenu = document.getElementById('menu-ui');
        const uiGame = document.getElementById('game-ui');
        const btnToEnv1 = document.getElementById('btn-to-env1');
        const btnToEnv2 = document.getElementById('btn-to-env2');
        const btnToMenu = document.getElementById('btn-to-menu');
        const btnToOther = document.getElementById('btn-to-other');
        const container = document.getElementById('app-container');

        // --- Inicialización ---
        function init() {
            clock = new THREE.Clock();
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            renderer.setAnimationLoop(animate);
            renderer.xr.enabled = true;
            document.body.appendChild(VRButton.createButton(renderer));
            container.appendChild(renderer.domElement);

            // --- Configuración de Interacción VR ---
            raycaster = new THREE.Raycaster();
            interactableGroup = new THREE.Group(); // Grupo para botones 3D
            scene.add(interactableGroup);

            // 1. El punto blanco (Retícula)
            const reticleGeo = new THREE.CircleGeometry(0.002, 16); // Pequeño círculo
            const reticleMat = new THREE.MeshBasicMaterial({ 
                color: 0xffffff, 
                fog: false, 
                depthTest: false, // Siempre visible
                transparent: true,
                opacity: 0.75
            });
            reticle = new THREE.Mesh(reticleGeo, reticleMat);
            reticle.position.z = -0.5; // A 50cm delante de la cámara
            reticle.renderOrder = 999; // Renderizar encima de todo
            camera.add(reticle); // Se mueve con la cámara

            // 2. El controlador (para el "clic")
            controller = renderer.xr.getController(0);
            controller.addEventListener('selectstart', onSelectStart);
            scene.add(controller);

            // 3. Listeners de sesión VR para mostrar/ocultar UIs
            renderer.xr.addEventListener('sessionstart', updateUIVisibility);
            renderer.xr.addEventListener('sessionend', updateUIVisibility);


            // --- Eventos de la UI HTML ---
            btnToEnv1.onclick = () => switchScene('ESCENARIO_1');
            btnToEnv2.onclick = () => switchScene('ESCENARIO_2');
            btnToMenu.onclick = () => switchScene('MENU');
            
            window.addEventListener('resize', onWindowResize);
            switchScene('MENU');
        }

        // --- Bucle de Animación ---
        function animate() {
            const delta = clock.getDelta();

            if (currentState === 'ESCENARIO_1' || currentState === 'ESCENARIO_2') {
                if (controls) controls.update();
            }
            if (currentState === 'ESCENARIO_2') {
                if (mixer) mixer.update(delta);
            }
            
            // Comprobar "hover" en VR
            handleControllerRaycast();

            renderer.render(scene, camera);
        }

        // --- Manejador de Estado (Cambio de Escena) ---
        function switchScene(newState) {
            currentState = newState;

            // 1. Limpiar la escena anterior
            scene.clear(); // Limpia modelos, luces, etc.
            interactableGroup.clear(); // Limpia botones VR
            if (mixer) mixer = null;
            if (controls) controls.dispose();

            // 2. Volver a añadir elementos persistentes
            scene.add(camera); // La cámara (con el retículo)
            scene.add(controller); // El controlador
            scene.add(interactableGroup); // El grupo de botones

            // 3. Configurar la nueva escena
            switch (newState) {
                case 'MENU':
                    setupMenu();
                    createVRMenu(); // Añade botones 3D al menú
                    break;
                
                case 'ESCENARIO_1':
                    setupEscenario1();
                    createVRGameUI(); // Añade botones 3D en-juego
                    break;
                
                case 'ESCENARIO_2':
                    setupEscenario2();
                    createVRGameUI(); // Añade botones 3D en-juego
                    break;
            }

            // 4. Actualizar visibilidad de UI (HTML vs VR)
            updateUIVisibility();
        }

        // --- Configuración de Escenas (sin cambios) ---
        function setupMenu() {
            scene.background = new THREE.Color(0x222222);
            camera.position.set(0, 0, 0.1);
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
            const material = new THREE.MeshNormalMaterial();
            const cube = new THREE.Mesh(geometry, material);
            cube.position.set(0, 0, -2);
            scene.add(cube);
        }

        function setupEscenario1() {
            scene.background = new THREE.Color(0x88ccee);
            scene.fog = new THREE.Fog(0x88ccee, 0, 50);
            const fillLight1 = new THREE.HemisphereLight(0x8dc1de, 0x00668d, 1.5);
            fillLight1.position.set(2, 1, 1);
            scene.add(fillLight1);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 2.5);
            directionalLight.position.set(-5, 25, -1);
            scene.add(directionalLight);
            camera.position.set(0, 8, 0);
            controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 0, 0);
            controls.enableDamping = true;
            controls.enablePan = false;
            const loader = new GLTFLoader();
            loader.load('models/mapa_final_simpson.glb', (gltf) => {
                scene.add(gltf.scene);
            });
        }

        function setupEscenario2() {
            scene.background = new THREE.Color(0xa0e9ff);
            scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.5));
            const dirLight = new THREE.DirectionalLight(0xffffff, 2.5);
            dirLight.position.set(1, 2, 3);
            scene.add(dirLight);
            const floorGeo = new THREE.PlaneGeometry(100, 100);
            const floorMat = new THREE.MeshStandardMaterial({ color: 0x99ff99, side: THREE.DoubleSide });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);
            camera.position.set(2, 2, 5);
            controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 1, 0);
            controls.enableDamping = true;
            const loader = new GLTFLoader();
            loader.load('https://threejs.org/examples/models/gltf/Soldier.glb', (gltf) => {
                const model = gltf.scene;
                scene.add(model);
                mixer = new THREE.AnimationMixer(model);
                mixer.clipAction(gltf.animations[0]).play();
            });
        }

        // --- NUEVAS Funciones de UI VR ---

        /**
         * Crea un mesh de botón 3D con texto.
         * @param {string} text - El texto a mostrar.
         * @param {string} name - El nombre del objeto (para el raycaster).
         * @param {number} yPos - La posición Y en la escena.
         * @returns {THREE.Mesh}
         */
        function createButtonMesh(text, name, yPos) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 512;
            canvas.height = 128;
            
            // Fondo del botón
            ctx.fillStyle = '#007bff'; // Azul
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Texto del botón (BLANCO)
            ctx.fillStyle = 'white'; 
            ctx.font = '60px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);
            
            const texture = new THREE.CanvasTexture(canvas);
            const geometry = new THREE.PlaneGeometry(1, 0.25); // Aspecto 4:1
            const material = new THREE.MeshBasicMaterial({ map: texture, transparent: true });
            
            const mesh = new THREE.Mesh(geometry, material);
            mesh.name = name;
            mesh.position.set(0, yPos, -2); // 2 metros delante de la cámara
            
            return mesh;
        }

        /** Crea los botones 3D para el menú principal */
        function createVRMenu() {
            const btn1 = createButtonMesh('Ir al Mapa (Entorno 1)', 'btn-to-env1', 0.25);
            const btn2 = createButtonMesh('Ir al Personaje (Entorno 2)', 'btn-to-env2', -0.25);
            interactableGroup.add(btn1);
            interactableGroup.add(btn2);
        }

        /** Crea los botones 3D para la UI en-juego */
        function createVRGameUI() {
            const btnMenu = createButtonMesh('Volver al Menú', 'btn-to-menu', 0.25);
            interactableGroup.add(btnMenu);

            let text, name;
            if (currentState === 'ESCENARIO_1') {
                text = 'Ir al Personaje (E2)';
                name = 'btn-to-env2';
            } else { // ESCENARIO_2
                text = 'Ir al Mapa (E1)';
                name = 'btn-to-env1';
            }
            const btnOther = createButtonMesh(text, name, -0.25);
            interactableGroup.add(btnOther);
        }

        /** Actualiza qué UI es visible (HTML o VR) */
        function updateUIVisibility() {
            const isVR = renderer.xr.isPresenting;
            
            reticle.visible = isVR; // El punto blanco
            interactableGroup.visible = isVR; // Los botones 3D

            if (isVR) {
                // Si estamos en VR, ocultar TODOS los menús HTML
                uiMenu.style.display = 'none';
                uiGame.style.display = 'none';
            } else {
                // Si estamos en PC, mostrar el menú HTML correcto
                uiMenu.style.display = (currentState === 'MENU') ? 'flex' : 'none';
                uiGame.style.display = (currentState !== 'MENU') ? 'flex' : 'none';
                
                // Actualizar texto de botones HTML
                if (currentState === 'ESCENARIO_1') {
                    btnToOther.innerText = 'Ir al Personaje (E2)';
                    btnToOther.onclick = () => switchScene('ESCENARIO_2');
                } else if (currentState === 'ESCENARIO_2') {
                    btnToOther.innerText = 'Ir al Mapa (E1)';
                    btnToOther.onclick = () => switchScene('ESCENARIO_1');
                }
            }
        }

        /** Maneja el "hover" (mirar) en VR */
        function handleControllerRaycast() {
            if (!renderer.xr.isPresenting) return; // Solo en VR

            // Lanza el rayo desde el centro de la cámara (gaze-based)
            raycaster.setFromCamera({ x: 0, y: 0 }, camera);
            const intersects = raycaster.intersectObjects(interactableGroup.children);

            // Resetear escala de todos los botones
            interactableGroup.children.forEach(child => {
                child.scale.set(1, 1, 1);
            });

            if (intersects.length > 0) {
                // El botón que está siendo mirado se agranda
                intersects[0].object.scale.set(1.2, 1.2, 1.2);
            }
        }

        /** Maneja el "clic" (gatillo) en VR */
        function onSelectStart() {
            if (!renderer.xr.isPresenting) return;

            // Lanza el rayo de nuevo para confirmar el clic
            raycaster.setFromCamera({ x: 0, y: 0 }, camera);
            const intersects = raycaster.intersectObjects(interactableGroup.children);

            if (intersects.length > 0) {
                const selectedObject = intersects[0].object;
                
                // Cambia de escena según el nombre del botón
                switch (selectedObject.name) {
                    case 'btn-to-env1':
                        switchScene('ESCENARIO_1');
                        break;
                    case 'btn-to-env2':
                        switchScene('ESCENARIO_2');
                        break;
                    case 'btn-to-menu':
                        switchScene('MENU');
                        break;
                }
            }
        }

        // --- Manejador de Redimensión ---
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- Iniciar la aplicación ---
        init();

    </script>
</body>
</html>